<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFES Electrical Services - Roster</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/ifes-app/ifes-app.github.io/refs/heads/main/IFES%20TearDrop.png">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* IFES Blue Branding */
        .bg-ifes-blue { background-color: #005a9c; } 
        .text-ifes-blue { color: #005a9c; }
        .border-ifes-blue { border-color: #005a9c; }
        .bg-ifes-light { background-color: #f0f7ff; }

        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            
            body { 
                background: white !important; 
                min-height: 0 !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Fix navigation to top of page */
            nav {
                position: static !important;
                top: 0 !important;
                height: auto !important;
                border-bottom: 2px solid #005a9c !important;
                padding-bottom: 10px !important;
                margin-bottom: 20px !important;
            }
            
            /* Pull main content up */
            main {
                padding-top: 10px !important;
                margin-top: 0 !important;
            }

            .print-break { page-break-inside: avoid; }
            
            /* Ensure background colors print if user has that setting enabled, otherwise provide borders */
            .bg-blue-50 { border: 1px solid #e2e8f0; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <!-- Navbar / Header -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo Area -->
                <div class="flex items-center gap-4">
                    <!-- Updated Logo Image -->
                    <img src="https://raw.githubusercontent.com/ifes-app/ifes-app.github.io/refs/heads/main/IFES%20TearDrop.png" 
                         alt="IFES Teardrop Logo" 
                         class="w-12 h-auto shrink-0 drop-shadow-sm">
                    
                    <div>
                        <h1 class="text-xl font-bold text-slate-900 leading-tight">IFES Electrical Services Ltd.</h1>
                        <p class="text-xs text-slate-500 font-medium tracking-wide uppercase">Weekly Roster System</p>
                    </div>
                </div>

                <!-- View Switcher (Desktop) -->
                <div class="hidden md:flex bg-slate-100 p-1 rounded-lg no-print">
                    <button onclick="switchView('table')" id="btn-table" class="px-4 py-2 rounded-md text-sm font-medium transition-all shadow-sm bg-white text-slate-900">
                        Table View
                    </button>
                    <button onclick="switchView('calendar')" id="btn-calendar" class="px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-900">
                        Calendar View
                    </button>
                    <button onclick="switchView('dashboard')" id="btn-dashboard" class="px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-900">
                        Dashboard
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="animate-spin w-10 h-10 border-4 border-ifes-blue border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-slate-500">Loading roster data...</p>
        </div>

        <!-- Main Content (Hidden until loaded) -->
        <div id="mainContent" class="hidden space-y-8">
            
            <!-- Hero Card: Who is on this week? -->
            <div class="bg-white border-t-4 border-ifes-blue rounded-2xl shadow-lg p-6 md:p-8 relative overflow-hidden print-break">
                <!-- Decorative background elements -->
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-50 rounded-full -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-blue-100 text-ifes-blue text-xs font-bold uppercase tracking-wider mb-2 border border-blue-200">
                                <span class="w-2 h-2 rounded-full bg-ifes-blue animate-pulse"></span>
                                Active Now
                            </span>
                            <h2 class="text-3xl font-bold text-slate-900">This Week's Team</h2>
                            <p id="currentWeekRange" class="text-slate-500 mt-1 font-medium">Week Ending: Loading...</p>
                        </div>
                        
                        <!-- Green Pill Top Right -->
                        <div class="flex items-center">
                            <!-- Added whitespace-nowrap and increased padding to px-4 py-1.5 -->
                            <span class="inline-flex items-center gap-1.5 px-4 py-1.5 rounded-full bg-green-100 text-green-700 text-xs font-bold uppercase tracking-wider border border-green-200 shadow-sm whitespace-nowrap">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                On Call
                            </span>
                        </div>
                    </div>

                    <div id="currentShiftCard" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>

            <!-- Mobile View Switcher -->
            <div class="md:hidden flex bg-slate-100 p-1 rounded-lg no-print">
                <button onclick="switchView('table')" id="btn-table-m" class="flex-1 py-2 rounded-md text-sm font-medium transition-all shadow-sm bg-white text-slate-900">Table</button>
                <button onclick="switchView('calendar')" id="btn-calendar-m" class="flex-1 py-2 rounded-md text-sm font-medium transition-all text-slate-500">Calendar</button>
                <button onclick="switchView('dashboard')" id="btn-dashboard-m" class="flex-1 py-2 rounded-md text-sm font-medium transition-all text-slate-500">Dash</button>
            </div>

            <!-- Toolbar (Hidden on Dashboard) -->
            <div id="toolbar" class="flex flex-col sm:flex-row justify-between gap-4 items-center no-print">
                <div class="relative w-full sm:w-72">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="searchInput" placeholder="Search name or week..." 
                        class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm shadow-sm">
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button onclick="window.print()" class="flex-1 sm:flex-none items-center justify-center gap-2 px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-sm font-medium shadow-sm">
                        <i data-lucide="printer" class="w-4 h-4"></i>
                        Print
                    </button>
                    <button onclick="fetchData()" class="flex-1 sm:flex-none items-center justify-center gap-2 px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors text-sm font-medium shadow-sm">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Table View -->
            <div id="tableView" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200">
                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Week #</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Generator</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Mercy Status</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Week Ending</th>
                            </tr>
                        </thead>
                        <tbody id="rosterTableBody" class="divide-y divide-slate-100">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>
                <div id="emptySearch" class="hidden p-12 text-center text-slate-500">
                    <p>No roster entries found matching your search.</p>
                </div>
            </div>

            <!-- Calendar/Card View -->
            <div id="calendarView" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cards injected here -->
            </div>

            <!-- Dashboard View -->
            <div id="dashboardView" class="hidden space-y-6">
                <!-- Stats Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Total Scheduled Weeks</div>
                        <div class="text-3xl font-bold text-slate-900" id="statTotalWeeks">-</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Most Active Technician</div>
                        <div class="text-2xl font-bold text-ifes-blue truncate" id="statTopTech">-</div>
                        <div class="text-xs text-slate-400 mt-1" id="statTopTechCount">Calculating...</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-2">Upcoming Mercy</div>
                        <div class="text-2xl font-bold text-green-600 truncate" id="statNextMercy">-</div>
                        <div class="text-xs text-slate-400 mt-1" id="statNextMercyDate">-</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Bar Chart (Workload) -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i data-lucide="bar-chart-2" class="w-4 h-4 text-ifes-blue"></i>
                            Shift Distribution (Workload)
                        </h3>
                        <div class="h-64">
                            <canvas id="workloadChart"></canvas>
                        </div>
                    </div>
                    <!-- Doughnut Chart (Mercy) -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                            <i data-lucide="pie-chart" class="w-4 h-4 text-green-600"></i>
                            Mercy / On Call Split
                        </h3>
                        <div class="h-64 flex justify-center">
                            <canvas id="mercyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <footer class="bg-slate-50 border-t border-slate-200 mt-auto py-8 text-center no-print">
        <p class="text-sm text-slate-400">Â© 2026 IFES Electrical Services Ltd. | Internal Roster System</p>
        <div class="text-xs text-slate-400 mt-2 font-light">Created by Dave Maher</div>
    </footer>

    <script>
        // --- Configuration ---
        const SHEET_ID = '2PACX-1vS5iyyw7RwRFZgFUjw6fmWvoTcCO4jww2_RbzfSeWFuELT5GxjRvcIM_8-1MRHnkg';
        const GID = '205333064';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=${GID}&single=true&output=csv`;
        
        let rosterData = [];
        let currentView = 'table';
        let currentWeekEntry = null;
        
        // Chart instances
        let workloadChartInstance = null;
        let mercyChartInstance = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchData();

            document.getElementById('searchInput').addEventListener('input', (e) => {
                renderAll(e.target.value);
            });
        });

        // --- View Switching ---
        function switchView(view) {
            currentView = view;
            
            // Buttons
            const btns = {
                table: { d: document.getElementById('btn-table'), m: document.getElementById('btn-table-m') },
                calendar: { d: document.getElementById('btn-calendar'), m: document.getElementById('btn-calendar-m') },
                dashboard: { d: document.getElementById('btn-dashboard'), m: document.getElementById('btn-dashboard-m') }
            };

            // Views
            const views = {
                table: document.getElementById('tableView'),
                calendar: document.getElementById('calendarView'),
                dashboard: document.getElementById('dashboardView')
            };
            
            const toolbar = document.getElementById('toolbar');

            // Reset all buttons
            const activeClass = ['bg-white', 'text-slate-900', 'shadow-sm'];
            const inactiveClass = ['text-slate-500', 'hover:text-slate-900', 'bg-transparent', 'shadow-none'];

            Object.keys(btns).forEach(key => {
                const isTarget = key === view;
                const dBtn = btns[key].d;
                const mBtn = btns[key].m;

                if (isTarget) {
                    dBtn.classList.add(...activeClass);
                    dBtn.classList.remove(...inactiveClass);
                    mBtn.classList.add(...activeClass);
                    mBtn.classList.remove('text-slate-500');
                } else {
                    dBtn.classList.remove(...activeClass);
                    dBtn.classList.add(...inactiveClass);
                    mBtn.classList.remove(...activeClass);
                    mBtn.classList.add('text-slate-500');
                }
            });

            // Toggle Views
            Object.keys(views).forEach(key => {
                if (key === view) views[key].classList.remove('hidden');
                else views[key].classList.add('hidden');
            });

            // Handle Toolbar visibility (Hide search on dashboard)
            if (view === 'dashboard') {
                toolbar.classList.add('hidden');
                renderDashboard(); // Trigger chart render
            } else {
                toolbar.classList.remove('hidden');
            }
        }

        // --- Data Fetching & Parsing ---
        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('Network error');
                const text = await response.text();
                
                const { headers, data } = parseCSV(text);
                
                rosterData = data.map(row => {
                    const findVal = (key) => {
                        const headerKey = headers.find(h => h.toLowerCase().includes(key.toLowerCase()));
                        return headerKey ? row[headerKey] : '';
                    };

                    return {
                        week: findVal('Week') || findVal('Wk') || '',
                        weekEnding: findVal('Week Ending') || findVal('Date') || '',
                        name: findVal('Name') || 'Unassigned',
                        generator: findVal('Generator') || '-',
                        mercyRaw: findVal('Mercy') || '-' 
                    };
                });

                rosterData = rosterData.filter(item => 
                    item.name && item.name.trim() !== '' && 
                    item.week && item.week.trim() !== ''
                );

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                determineCurrentWeek();
                renderAll();
                
            } catch (error) {
                console.error(error);
                document.getElementById('loadingState').innerHTML = `<p class="text-red-500">Error loading roster. Please refresh.</p>`;
            }
        }

        function parseCSV(text) {
            const lines = text.split(/\r\n|\n/);
            const headers = parseCSVLine(lines[0]);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((h, idx) => row[h] = values[idx] || '');
                data.push(row);
            }
            return { headers, data };
        }

        function parseCSVLine(line) {
            const result = [];
            let startValue = 0;
            let insideQuote = false;
            for (let i = 0; i < line.length; i++) {
                if (line[i] === '"') insideQuote = !insideQuote;
                else if (line[i] === ',' && !insideQuote) {
                    let val = line.substring(startValue, i).trim();
                    if (val.startsWith('"') && val.endsWith('"')) val = val.substring(1, val.length - 1).replace(/""/g, '"');
                    result.push(val);
                    startValue = i + 1;
                }
            }
            let lastVal = line.substring(startValue).trim();
            if (lastVal.startsWith('"') && lastVal.endsWith('"')) lastVal = lastVal.substring(1, lastVal.length - 1).replace(/""/g, '"');
            result.push(lastVal);
            return result;
        }

        // --- Logic Helpers ---

        function isMercyOnCall(val) {
            return val && val.toUpperCase().includes('IFES');
        }

        function getMercyBadgeHTML(val, isCard = false) {
            if (isMercyOnCall(val)) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-800 border border-green-200">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1.5"></span>
                    ON CALL
                </span>`;
            } else {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-500 border border-slate-200">
                    OFF
                </span>`;
            }
        }

        // --- Date Logic ---
        function parseDate(dateStr) {
            if (!dateStr) return null;
            try {
                const parts = dateStr.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/);
                if (parts) {
                    return new Date(`${parts[3]}-${parts[2]}-${parts[1]}`);
                }
                const d = new Date(dateStr);
                return isNaN(d) ? null : d;
            } catch (e) { return null; }
        }

        function determineCurrentWeek() {
            const today = new Date();
            today.setHours(0,0,0,0);
            let currentItem = null;
            let minDiff = Infinity;

            rosterData.forEach(item => {
                const d = parseDate(item.weekEnding);
                if (d) {
                    const diff = d - today;
                    if (diff >= -86400000 * 2 && diff < minDiff) { 
                         minDiff = diff;
                         currentItem = item;
                    }
                }
            });

            currentWeekEntry = currentItem;

            const dashboard = document.getElementById('currentShiftCard');
            const weekRange = document.getElementById('currentWeekRange');

            if (currentItem) {
                weekRange.textContent = `Week Ending: ${currentItem.weekEnding}`;
                
                const mercyStatus = isMercyOnCall(currentItem.mercyRaw) 
                    ? `<div class="text-green-600 font-bold flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div> ON CALL</div>`
                    : `<div class="text-slate-400 font-medium">OFF</div>`;

                dashboard.innerHTML = `
                    <div class="bg-blue-50/50 rounded-xl p-4 border border-blue-100 relative group">
                        <div class="text-slate-400 text-xs uppercase tracking-wider mb-1 font-bold">On Duty</div>
                        <div class="text-2xl font-bold text-slate-800 truncate pr-6">${currentItem.name}</div>
                    </div>
                    <div class="bg-blue-50/50 rounded-xl p-4 border border-blue-100 relative">
                        <div class="text-slate-400 text-xs uppercase tracking-wider mb-1 font-bold">Generator</div>
                        <div class="text-xl font-semibold text-slate-700 truncate pr-6">${currentItem.generator}</div>
                    </div>
                    <div class="bg-blue-50/50 rounded-xl p-4 border border-blue-100">
                        <div class="text-slate-400 text-xs uppercase tracking-wider mb-1 font-bold">Mercy</div>
                        <div class="text-xl font-semibold truncate">${mercyStatus}</div>
                    </div>
                `;
            } else {
                weekRange.textContent = "No active roster found for this week.";
                dashboard.innerHTML = `<div class="col-span-3 text-center text-slate-400">No data available for current date.</div>`;
            }
        }

        // --- Dashboard Logic ---
        function renderDashboard() {
            if (!rosterData.length) return;

            // 1. Calculate Statistics
            const nameCounts = {};
            let mercyCount = 0;
            let totalWeeks = rosterData.length;
            let upcomingMercy = { name: '-', date: '-' };
            
            const today = new Date();
            today.setHours(0,0,0,0);
            
            let foundNextMercy = false;

            rosterData.forEach(row => {
                // Count workload
                if (nameCounts[row.name]) nameCounts[row.name]++;
                else nameCounts[row.name] = 1;

                // Count mercy
                if (isMercyOnCall(row.mercyRaw)) {
                    mercyCount++;
                    // Find upcoming mercy
                    if (!foundNextMercy) {
                        const d = parseDate(row.weekEnding);
                        if (d && d > today) {
                            upcomingMercy = { name: row.name, date: row.weekEnding };
                            foundNextMercy = true;
                        }
                    }
                }
            });

            // Detect Ties for "Most Active"
            let maxCount = 0;
            for (const count of Object.values(nameCounts)) {
                if (count > maxCount) maxCount = count;
            }

            const topTechs = Object.entries(nameCounts)
                .filter(([name, count]) => count === maxCount)
                .map(([name]) => name);

            const totalTechs = Object.keys(nameCounts).length;

            if (topTechs.length === totalTechs && totalTechs > 0) {
                 // Perfect balance
                 document.getElementById('statTopTech').textContent = "Balanced Schedule";
                 document.getElementById('statTopTechCount').textContent = `${maxCount} shifts each across ${totalTechs} techs`;
            } else if (topTechs.length > 1) {
                 // Tie
                 document.getElementById('statTopTech').textContent = `${topTechs.length} Techs Tied`;
                 document.getElementById('statTopTechCount').textContent = `${maxCount} shifts each (${topTechs.slice(0, 2).join(', ')}...)`;
            } else {
                 // Single winner
                 document.getElementById('statTopTech').textContent = topTechs[0];
                 document.getElementById('statTopTechCount').textContent = `${maxCount} shifts assigned`;
            }

            // Update DOM Stats
            document.getElementById('statTotalWeeks').textContent = totalWeeks;
            document.getElementById('statNextMercy').textContent = upcomingMercy.name;
            document.getElementById('statNextMercyDate').textContent = upcomingMercy.date;

            // 2. Render Charts using Chart.js
            
            // Workload Chart Data
            const labels = Object.keys(nameCounts);
            const dataCounts = Object.values(nameCounts);

            // Destroy old charts if they exist
            if (workloadChartInstance) workloadChartInstance.destroy();
            if (mercyChartInstance) mercyChartInstance.destroy();

            // Create Workload Bar Chart
            const ctx1 = document.getElementById('workloadChart').getContext('2d');
            workloadChartInstance = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weeks Assigned',
                        data: dataCounts,
                        backgroundColor: '#005a9c',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } },
                        x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 } }
                    }
                }
            });

            // Create Mercy Pie Chart
            const ctx2 = document.getElementById('mercyChart').getContext('2d');
            mercyChartInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['On Call (Mercy)', 'Regular Duties'],
                    datasets: [{
                        data: [mercyCount, totalWeeks - mercyCount],
                        backgroundColor: ['#16a34a', '#e2e8f0'], // Green for Mercy, Grey for off
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        // --- Rendering ---
        function renderAll(search = '') {
            const lowerSearch = search.toLowerCase();
            const filtered = rosterData.filter(item => {
                return Object.values(item).some(val => String(val).toLowerCase().includes(lowerSearch));
            });

            renderTable(filtered);
            renderCalendar(filtered);
            
            if (filtered.length === 0) {
                document.getElementById('emptySearch').classList.remove('hidden');
            } else {
                document.getElementById('emptySearch').classList.add('hidden');
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('rosterTableBody');
            tbody.innerHTML = data.map(row => {
                const isCurrent = currentWeekEntry && 
                                row.week === currentWeekEntry.week && 
                                row.weekEnding === currentWeekEntry.weekEnding;

                const rowClass = isCurrent 
                    ? "bg-blue-50 border-l-4 border-l-ifes-blue border-b border-blue-100 shadow-sm" 
                    : "hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0 border-l-4 border-l-transparent";
                
                const weekContent = isCurrent 
                    ? `<div class="flex items-center gap-2 text-ifes-blue font-bold">${row.week}</div>` 
                    : `<span class="text-slate-500 font-medium">${row.week}</span>`;

                return `
                <tr class="${rowClass}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${weekContent}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-900">${row.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${row.generator}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${getMercyBadgeHTML(row.mercyRaw)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 text-right font-mono">${row.weekEnding}</td>
                </tr>
            `}).join('');
        }

        function renderCalendar(data) {
            const container = document.getElementById('calendarView');
            container.innerHTML = data.map(row => {
                const isCurrent = currentWeekEntry && 
                                row.week === currentWeekEntry.week && 
                                row.weekEnding === currentWeekEntry.weekEnding;
                
                const borderClass = isCurrent ? "border-ifes-blue ring-1 ring-ifes-blue" : "border-slate-200";
                const bgClass = isCurrent ? "bg-blue-50/30" : "bg-white";

                return `
                <div class="${bgClass} rounded-xl shadow-sm border ${borderClass} p-5 hover:shadow-md transition-all print-break relative">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Week ${row.week}</span>
                            <div class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="calendar" class="w-4 h-4 text-ifes-blue"></i>
                                ${row.weekEnding}
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex items-center gap-3 p-2 rounded-lg bg-blue-50 border border-blue-100">
                            <div class="w-8 h-8 rounded-full bg-ifes-blue flex items-center justify-center text-white font-bold text-xs">
                                ${getInitials(row.name)}
                            </div>
                            <div>
                                <div class="text-xs text-blue-600 font-semibold uppercase">Primary Name</div>
                                <div class="text-sm font-bold text-slate-900">${row.name}</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-2 rounded-lg bg-slate-50 border border-slate-100">
                                <div class="text-xs text-slate-500 font-medium mb-1">Generator</div>
                                <div class="text-sm font-semibold text-slate-700 truncate">${row.generator}</div>
                            </div>
                            <div class="p-2 rounded-lg bg-slate-50 border border-slate-100 flex flex-col justify-center">
                                <div class="text-xs text-slate-500 font-medium mb-1">Mercy</div>
                                <div>${getMercyBadgeHTML(row.mercyRaw, true)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
        }

    </script>
</body>
</html>
