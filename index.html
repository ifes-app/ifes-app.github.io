<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFES Electrical Services - Roster</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/ifes-app/ifes-app.github.io/refs/heads/main/IFES%20TearDrop.png">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* IFES Blue Branding */
        .bg-ifes-blue { background-color: #005a9c; } 
        .text-ifes-blue { color: #005a9c; }
        .border-ifes-blue { border-color: #005a9c; }
        .bg-ifes-light { background-color: #f0f7ff; }

        /* Print styles */
        @media print {
            .no-print { display: none; }
            body { background: white; }
            .print-break { page-break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <!-- Navbar / Header -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <!-- Logo Area -->
                <div class="flex items-center gap-4">
                    <!-- Updated Logo Image -->
                    <img src="https://raw.githubusercontent.com/ifes-app/ifes-app.github.io/refs/heads/main/IFES%20TearDrop.png" 
                         alt="IFES Teardrop Logo" 
                         class="w-12 h-auto shrink-0 drop-shadow-sm">
                    
                    <div>
                        <h1 class="text-xl font-bold text-slate-900 leading-tight">IFES Electrical Services Ltd.</h1>
                        <p class="text-xs text-slate-500 font-medium tracking-wide uppercase">Weekly Roster System</p>
                    </div>
                </div>

                <!-- View Switcher (Desktop) -->
                <div class="hidden md:flex bg-slate-100 p-1 rounded-lg no-print">
                    <button onclick="switchView('table')" id="btn-table" class="px-4 py-2 rounded-md text-sm font-medium transition-all shadow-sm bg-white text-slate-900">
                        Table View
                    </button>
                    <button onclick="switchView('calendar')" id="btn-calendar" class="px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-900">
                        Calendar View
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="animate-spin w-10 h-10 border-4 border-ifes-blue border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-slate-500">Loading roster data...</p>
        </div>

        <!-- Main Content (Hidden until loaded) -->
        <div id="mainContent" class="hidden space-y-8">
            
            <!-- Hero Card: Who is on this week? -->
            <!-- Updated to White/Light Blue theme for readability -->
            <div class="bg-white border-t-4 border-ifes-blue rounded-2xl shadow-lg p-6 md:p-8 relative overflow-hidden">
                <!-- Decorative background elements -->
                <div class="absolute top-0 right-0 w-64 h-64 bg-blue-50 rounded-full -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                
                <div class="relative z-10">
                    <div class="flex flex-col md:flex-row justify-between md:items-start gap-4 mb-6">
                        <div>
                            <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-blue-100 text-ifes-blue text-xs font-bold uppercase tracking-wider mb-2 border border-blue-200">
                                <span class="w-2 h-2 rounded-full bg-ifes-blue animate-pulse"></span>
                                Active Now
                            </span>
                            <h2 class="text-3xl font-bold text-slate-900">This Week's Team</h2>
                            <p id="currentWeekRange" class="text-slate-500 mt-1 font-medium">Week Ending: Loading...</p>
                        </div>
                        <div class="hidden md:block">
                            <i data-lucide="calendar-clock" class="w-12 h-12 text-blue-100"></i>
                        </div>
                    </div>

                    <div id="currentShiftCard" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>

            <!-- Mobile View Switcher -->
            <div class="md:hidden flex bg-slate-100 p-1 rounded-lg no-print">
                <button onclick="switchView('table')" id="btn-table-m" class="flex-1 py-2 rounded-md text-sm font-medium transition-all shadow-sm bg-white text-slate-900">Table</button>
                <button onclick="switchView('calendar')" id="btn-calendar-m" class="flex-1 py-2 rounded-md text-sm font-medium transition-all text-slate-500">Calendar</button>
            </div>

            <!-- Toolbar -->
            <div class="flex flex-col sm:flex-row justify-between gap-4 items-center no-print">
                <div class="relative w-full sm:w-72">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="searchInput" placeholder="Search name or week..." 
                        class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm shadow-sm">
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button onclick="window.print()" class="flex-1 sm:flex-none items-center justify-center gap-2 px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-sm font-medium shadow-sm">
                        <i data-lucide="printer" class="w-4 h-4"></i>
                        Print
                    </button>
                    <button onclick="fetchData()" class="flex-1 sm:flex-none items-center justify-center gap-2 px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors text-sm font-medium shadow-sm">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Table View -->
            <div id="tableView" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200">
                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Week #</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Week Ending</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Generator</th>
                                <th class="px-6 py-4 text-xs font-bold text-slate-500 uppercase tracking-wider">Mercy Status</th>
                            </tr>
                        </thead>
                        <tbody id="rosterTableBody" class="divide-y divide-slate-100">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>
                <div id="emptySearch" class="hidden p-12 text-center text-slate-500">
                    <p>No roster entries found matching your search.</p>
                </div>
            </div>

            <!-- Calendar/Card View -->
            <div id="calendarView" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Cards injected here -->
            </div>

        </div>
    </main>

    <footer class="bg-slate-50 border-t border-slate-200 mt-auto py-8 text-center no-print">
        <p class="text-sm text-slate-400">Â© 2026 IFES Electrical Services Ltd. | Internal Roster System</p>
    </footer>

    <script>
        // --- Configuration ---
        const SHEET_ID = '2PACX-1vS5iyyw7RwRFZgFUjw6fmWvoTcCO4jww2_RbzfSeWFuELT5GxjRvcIM_8-1MRHnkg';
        const GID = '205333064';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=${GID}&single=true&output=csv`;
        
        let rosterData = [];
        let currentView = 'table';

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchData();

            document.getElementById('searchInput').addEventListener('input', (e) => {
                renderAll(e.target.value);
            });
        });

        // --- View Switching ---
        function switchView(view) {
            currentView = view;
            const tableBtn = document.getElementById('btn-table');
            const calBtn = document.getElementById('btn-calendar');
            const tableBtnM = document.getElementById('btn-table-m');
            const calBtnM = document.getElementById('btn-calendar-m');
            const tableView = document.getElementById('tableView');
            const calendarView = document.getElementById('calendarView');

            // Reset Styles
            const activeClass = ['bg-white', 'text-slate-900', 'shadow-sm'];
            const inactiveClass = ['text-slate-500', 'hover:text-slate-900', 'bg-transparent', 'shadow-none'];

            // Update Desktop Buttons
            if (view === 'table') {
                tableBtn.classList.add(...activeClass);
                tableBtn.classList.remove(...inactiveClass);
                calBtn.classList.remove(...activeClass);
                calBtn.classList.add(...inactiveClass);
                
                tableBtnM.classList.add(...activeClass);
                tableBtnM.classList.remove('text-slate-500');
                calBtnM.classList.remove(...activeClass);
                calBtnM.classList.add('text-slate-500');

                tableView.classList.remove('hidden');
                calendarView.classList.add('hidden');
            } else {
                calBtn.classList.add(...activeClass);
                calBtn.classList.remove(...inactiveClass);
                tableBtn.classList.remove(...activeClass);
                tableBtn.classList.add(...inactiveClass);

                calBtnM.classList.add(...activeClass);
                calBtnM.classList.remove('text-slate-500');
                tableBtnM.classList.remove(...activeClass);
                tableBtnM.classList.add('text-slate-500');

                tableView.classList.add('hidden');
                calendarView.classList.remove('hidden');
            }
        }

        // --- Data Fetching & Parsing ---
        async function fetchData() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('Network error');
                const text = await response.text();
                
                const { headers, data } = parseCSV(text);
                
                rosterData = data.map(row => {
                    const findVal = (key) => {
                        const headerKey = headers.find(h => h.toLowerCase().includes(key.toLowerCase()));
                        return headerKey ? row[headerKey] : '';
                    };

                    return {
                        week: findVal('Week') || findVal('Wk') || '#',
                        weekEnding: findVal('Week Ending') || findVal('Date') || '',
                        name: findVal('Name') || 'Unassigned',
                        generator: findVal('Generator') || '-',
                        mercyRaw: findVal('Mercy') || '-' // Store raw value for logic
                    };
                });

                // Filter out empty rows
                rosterData = rosterData.filter(item => item.name && item.name.trim() !== '');

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                determineCurrentWeek();
                renderAll();
                
            } catch (error) {
                console.error(error);
                document.getElementById('loadingState').innerHTML = `<p class="text-red-500">Error loading roster. Please refresh.</p>`;
            }
        }

        function parseCSV(text) {
            const lines = text.split(/\r\n|\n/);
            const headers = parseCSVLine(lines[0]);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((h, idx) => row[h] = values[idx] || '');
                data.push(row);
            }
            return { headers, data };
        }

        function parseCSVLine(line) {
            const result = [];
            let startValue = 0;
            let insideQuote = false;
            for (let i = 0; i < line.length; i++) {
                if (line[i] === '"') insideQuote = !insideQuote;
                else if (line[i] === ',' && !insideQuote) {
                    let val = line.substring(startValue, i).trim();
                    if (val.startsWith('"') && val.endsWith('"')) val = val.substring(1, val.length - 1).replace(/""/g, '"');
                    result.push(val);
                    startValue = i + 1;
                }
            }
            let lastVal = line.substring(startValue).trim();
            if (lastVal.startsWith('"') && lastVal.endsWith('"')) lastVal = lastVal.substring(1, lastVal.length - 1).replace(/""/g, '"');
            result.push(lastVal);
            return result;
        }

        // --- Logic Helpers ---

        function isMercyOnCall(val) {
            // Case insensitive check for "IFES"
            return val && val.toUpperCase().includes('IFES');
        }

        function getMercyBadgeHTML(val, isCard = false) {
            if (isMercyOnCall(val)) {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-green-100 text-green-800 border border-green-200">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 mr-1.5"></span>
                    ON CALL
                </span>`;
            } else {
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-500 border border-slate-200">
                    OFF
                </span>`;
            }
        }

        // --- Date Logic ---
        function parseDate(dateStr) {
            if (!dateStr) return null;
            try {
                const parts = dateStr.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/);
                if (parts) {
                    return new Date(`${parts[3]}-${parts[2]}-${parts[1]}`);
                }
                const d = new Date(dateStr);
                return isNaN(d) ? null : d;
            } catch (e) { return null; }
        }

        function determineCurrentWeek() {
            const today = new Date();
            today.setHours(0,0,0,0);
            let currentItem = null;
            let minDiff = Infinity;

            rosterData.forEach(item => {
                const d = parseDate(item.weekEnding);
                if (d) {
                    const diff = d - today;
                    if (diff >= -86400000 * 2 && diff < minDiff) { 
                         minDiff = diff;
                         currentItem = item;
                    }
                }
            });

            const dashboard = document.getElementById('currentShiftCard');
            const weekRange = document.getElementById('currentWeekRange');

            if (currentItem) {
                weekRange.textContent = `Week Ending: ${currentItem.weekEnding}`;
                
                const mercyStatus = isMercyOnCall(currentItem.mercyRaw) 
                    ? `<div class="text-green-600 font-bold flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div> ON CALL</div>`
                    : `<div class="text-slate-400 font-medium">OFF</div>`;

                dashboard.innerHTML = `
                    <div class="bg-blue-50/50 rounded-xl p-4 border border-blue-100">
                        <div class="text-slate-400 text-xs uppercase tracking-wider mb-1 font-bold">On Duty</div>
                        <div class="text-2xl font-bold text-slate-800 truncate">${currentItem.name}</div>
                    </div>
                    <div class="bg-blue-50/50 rounded-xl p-4 border border-blue-100">
                        <div class="text-slate-400 text-xs uppercase tracking-wider mb-1 font-bold">Generator</div>
                        <div class="text-xl font-semibold text-slate-700 truncate">${currentItem.generator}</div>
                    </div>
                    <div class="bg-blue-50/50 rounded-xl p-4 border border-blue-100">
                        <div class="text-slate-400 text-xs uppercase tracking-wider mb-1 font-bold">Mercy</div>
                        <div class="text-xl font-semibold truncate">${mercyStatus}</div>
                    </div>
                `;
            } else {
                weekRange.textContent = "No active roster found for this week.";
                dashboard.innerHTML = `<div class="col-span-3 text-center text-slate-400">No data available for current date.</div>`;
            }
        }

        // --- Rendering ---
        function renderAll(search = '') {
            const lowerSearch = search.toLowerCase();
            const filtered = rosterData.filter(item => {
                return Object.values(item).some(val => String(val).toLowerCase().includes(lowerSearch));
            });

            renderTable(filtered);
            renderCalendar(filtered);

            if (filtered.length === 0) {
                document.getElementById('emptySearch').classList.remove('hidden');
            } else {
                document.getElementById('emptySearch').classList.add('hidden');
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('rosterTableBody');
            tbody.innerHTML = data.map(row => `
                <tr class="hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-medium">${row.week}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">${row.weekEnding}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-slate-900">${row.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">${row.generator}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${getMercyBadgeHTML(row.mercyRaw)}
                    </td>
                </tr>
            `).join('');
        }

        function renderCalendar(data) {
            const container = document.getElementById('calendarView');
            container.innerHTML = data.map(row => `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 hover:shadow-md transition-shadow print-break">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Week ${row.week}</span>
                            <div class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="calendar" class="w-4 h-4 text-ifes-blue"></i>
                                ${row.weekEnding}
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="flex items-center gap-3 p-2 rounded-lg bg-blue-50 border border-blue-100">
                            <div class="w-8 h-8 rounded-full bg-ifes-blue flex items-center justify-center text-white font-bold text-xs">
                                ${getInitials(row.name)}
                            </div>
                            <div>
                                <div class="text-xs text-blue-600 font-semibold uppercase">Primary Name</div>
                                <div class="text-sm font-bold text-slate-900">${row.name}</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <div class="p-2 rounded-lg bg-slate-50 border border-slate-100">
                                <div class="text-xs text-slate-500 font-medium mb-1">Generator</div>
                                <div class="text-sm font-semibold text-slate-700 truncate">${row.generator}</div>
                            </div>
                            <div class="p-2 rounded-lg bg-slate-50 border border-slate-100 flex flex-col justify-center">
                                <div class="text-xs text-slate-500 font-medium mb-1">Mercy</div>
                                <div>${getMercyBadgeHTML(row.mercyRaw, true)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
        }

    </script>
</body>
</html>
